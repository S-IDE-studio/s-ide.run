---
import PlatformCard from '../components/ui/PlatformCard.astro';
import Layout from '../layouts/Layout.astro';
import {
  formatFileSize,
  GitHubApiError,
  getAssetsByOS,
  getLatestRelease,
} from '../utils/github-api';

// Fetch latest release data from GitHub
interface PlatformAsset {
  url: string;
  size: string;
  name: string;
}

interface ReleaseData {
  windows: PlatformAsset | null;
  macos: PlatformAsset | null;
  linux: PlatformAsset | null;
  error: boolean;
}

const releaseData: ReleaseData = {
  windows: null,
  macos: null,
  linux: null,
  error: false,
};

try {
  const latestRelease = await getLatestRelease();
  const assets = getAssetsByOS(latestRelease);

  releaseData.windows = assets.windows
    ? {
        url: assets.windows.browser_download_url,
        size: formatFileSize(assets.windows.size),
        name: assets.windows.name,
      }
    : null;

  releaseData.macos = assets.macos
    ? {
        url: assets.macos.browser_download_url,
        size: formatFileSize(assets.macos.size),
        name: assets.macos.name,
      }
    : null;

  releaseData.linux = assets.linux
    ? {
        url: assets.linux.browser_download_url,
        size: formatFileSize(assets.linux.size),
        name: assets.linux.name,
      }
    : null;
} catch (error) {
  // Log error server-side but don't expose details to client
  if (error instanceof GitHubApiError) {
    console.error(`GitHub API Error ${error.status}: ${error.message}`);
  } else {
    console.error('Failed to fetch release data:', error);
  }
  releaseData.error = true;
}

// Helper to get download URL with fallback to GitHub releases
const getDownloadUrl = (asset: PlatformAsset | null): string => {
  return asset?.url || 'https://github.com/S-IDE-studio/S-IDE/releases';
};

// Check if asset is available
const isAvailable = (asset: PlatformAsset | null): boolean => {
  return asset !== null;
};
---

<Layout title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ - S-IDE">
  <section class="relative bg-black" style="min-height: 100vh; padding-bottom: 80px;">
    <!-- Grid Container -->
    <div class="relative mx-auto" style="width: 916px;">
      <!-- Page Title -->
      <h1 style="left: 0; top: 20px; color: #ffffff; font-family: Inter; font-size: 48px; font-weight: 700; margin-bottom: 20px;">
        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </h1>

      {releaseData.error && (
        <div style="background-color: #3b1a1a; border: 1px solid #ef4444; border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px;">
          <p style="color: #fca5a5; font-size: 14px; margin: 0;">
            GitHubãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯
            <a href="https://github.com/S-IDE-studio/S-IDE/releases" target="_blank" rel="noopener noreferrer" style="color: #60a5fa; text-decoration: underline;">GitHub Releases</a>
            ãƒšãƒ¼ã‚¸ã‹ã‚‰ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚
          </p>
        </div>
      )}

      <!-- Row 1: Windows and macOS -->
      <div class="flex" style="gap: 9px; margin-bottom: 9px;">
        <PlatformCard
          name="Windows"
          shortName="WIN"
          description="Windows 10/11 (64bit)"
          downloadUrl={getDownloadUrl(releaseData.windows)}
          fileSize={releaseData.windows?.size}
          buttonLabel="Installer"
          isAvailable={isAvailable(releaseData.windows)}
        />
        <PlatformCard
          name="macOS"
          shortName="MAC"
          description="macOS 12+"
          downloadUrl={getDownloadUrl(releaseData.macos)}
          fileSize={releaseData.macos?.size}
          buttonLabel="DMG"
          isAvailable={isAvailable(releaseData.macos)}
        />
      </div>

      <!-- Row 2: Linux and iOS -->
      <div class="flex" style="gap: 9px; margin-bottom: 9px;">
        <PlatformCard
          name="Linux"
          shortName="LIN"
          description="Ubuntu 20.04+ / Debian 11+"
          downloadUrl={getDownloadUrl(releaseData.linux)}
          fileSize={releaseData.linux?.size}
          buttonLabel="Download"
          isAvailable={isAvailable(releaseData.linux)}
        />
        <PlatformCard
          name="iOS"
          shortName="iOS"
          description="iOS"
          downloadUrl="#"
          isComingSoon={true}
          icon="ğŸ“±"
        />
      </div>

      <!-- Row 3: Android -->
      <div class="flex" style="gap: 9px;">
        <PlatformCard
          name="Android"
          shortName="Android"
          description="Android"
          downloadUrl="#"
          isComingSoon={true}
          icon="ğŸ¤–"
        />
      </div>

      <!-- GitHub Link -->
      <div class="text-center" style="margin-top: 48px;">
        <a
          href="https://github.com/S-IDE-studio/S-IDE/releases"
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-400 hover:underline transition-colors"
          style="font-size: 14px;"
        >
          View all releases on GitHub â†’
        </a>
      </div>
    </div>
  </section>
</Layout>
