---
import PlatformCard from '../components/ui/PlatformCard.astro';
import Layout from '../layouts/Layout.astro';
import { DISTRIBUTION } from '../config/distribution';
import {
  formatFileSize,
  GitHubApiError,
  getAssetsByOS,
  getLatestRelease,
} from '../utils/github-api';

// Fetch latest release data from GitHub
interface PlatformAsset {
  url: string;
  size: string;
  name: string;
}

interface ReleaseData {
  windows: PlatformAsset | null;
  macos: PlatformAsset | null;
  linux: PlatformAsset | null;
  mobile: {
    ios: {
      url: string;
      label: string;
    };
    android: {
      url: string;
      label: string;
    };
  };
  error: boolean;
}

const releaseData: ReleaseData = {
  windows: null,
  macos: null,
  linux: null,
  mobile: {
    ios: {
      url: DISTRIBUTION.ios.testflightUrl,
      label: 'TestFlight',
    },
    android: {
      url: DISTRIBUTION.android.playStoreUrl,
      label: 'Play Store',
    },
  },
  error: false,
};

try {
  const latestRelease = await getLatestRelease();
  const assets = getAssetsByOS(latestRelease);

  releaseData.windows = assets.windows
    ? {
        url: assets.windows.browser_download_url,
        size: formatFileSize(assets.windows.size),
        name: assets.windows.name,
      }
    : null;

  releaseData.macos = assets.macos
    ? {
        url: assets.macos.browser_download_url,
        size: formatFileSize(assets.macos.size),
        name: assets.macos.name,
      }
    : null;

  releaseData.linux = assets.linux
    ? {
        url: assets.linux.browser_download_url,
        size: formatFileSize(assets.linux.size),
        name: assets.linux.name,
      }
    : null;
} catch (error) {
  // Log error server-side but don't expose details to client
  if (error instanceof GitHubApiError) {
    console.error(`GitHub API Error ${error.status}: ${error.message}`);
  } else {
    console.error('Failed to fetch release data:', error);
  }
  releaseData.error = true;
}

// Helper to get download URL with fallback to GitHub releases
const getDownloadUrl = (asset: PlatformAsset | null): string => {
  if (!asset?.url) {
    return 'https://github.com/S-IDE-studio/S-IDE/releases';
  }
  // Use GitHub direct asset URL (it may redirect to the actual storage URL; browsers handle this well).
  return asset.url;
};

// Check if asset is available
const isAvailable = (asset: PlatformAsset | null): boolean => {
  return asset !== null;
};
---

<Layout title="ダウンロード - S-IDE">
  <section class="relative bg-black download-section">
    <!-- Grid Container -->
    <div class="relative download-container">
      <!-- Page Title -->
      <h1 class="download-title">
        ダウンロード
      </h1>

      {releaseData.error && (
        <div role="alert" style="background-color: #3b1a1a; border: 1px solid #ef4444; border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px;">
          <p style="color: #fca5a5; font-size: 14px; margin: 0;">
            GitHubリリース情報の取得に失敗しました。最新バージョンは
            <a href="https://github.com/S-IDE-studio/S-IDE/releases" target="_blank" rel="noopener noreferrer" style="color: #60a5fa; text-decoration: underline;">GitHub Releases</a>
            ページからご確認いただけます。
          </p>
        </div>
      )}

      <!-- Row 1: Windows and macOS -->
      <div class="download-row">
        <PlatformCard
          name="Windows"
          shortName="WIN"
          description="Windows 10/11 (64bit)"
          downloadUrl={getDownloadUrl(releaseData.windows)}
          fileSize={releaseData.windows?.size}
          buttonLabel="Installer"
          isAvailable={isAvailable(releaseData.windows)}
        />
        <PlatformCard
          name="macOS"
          shortName="MAC"
          description="macOS 12+"
          downloadUrl={getDownloadUrl(releaseData.macos)}
          fileSize={releaseData.macos?.size}
          buttonLabel="DMG"
          isAvailable={isAvailable(releaseData.macos)}
        />
      </div>

      <!-- Row 2: Linux and iOS -->
      <div class="download-row">
        <PlatformCard
          name="Linux"
          shortName="LIN"
          description="Ubuntu 20.04+ / Debian 11+"
          downloadUrl={getDownloadUrl(releaseData.linux)}
          fileSize={releaseData.linux?.size}
          buttonLabel="Download"
          isAvailable={isAvailable(releaseData.linux)}
        />
        <PlatformCard
          name="iOS"
          shortName="iOS"
          description="Join via TestFlight"
          downloadUrl={releaseData.mobile.ios.url}
          buttonLabel={releaseData.mobile.ios.label}
          isAvailable={true}
          external={true}
        />
      </div>

      <!-- Row 3: Android -->
      <div class="download-row">
        <PlatformCard
          name="Android"
          shortName="Android"
          description="Get it on Google Play"
          downloadUrl={releaseData.mobile.android.url}
          buttonLabel={releaseData.mobile.android.label}
          isAvailable={true}
          external={true}
        />
      </div>

      <!-- GitHub Link -->
      <div class="text-center download-github">
        <a
          href="https://github.com/S-IDE-studio/S-IDE/releases"
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-400 hover:underline transition-colors"
          style="font-size: 14px;"
        >
          View all releases on GitHub →
        </a>
      </div>
    </div>
  </section>

  <style scoped>
    .download-section {
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .download-title {
      color: #ffffff;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Noto Sans JP', sans-serif;
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .download-github {
      margin-top: 48px;
    }

    @media (max-width: 479px) {
      .download-title {
        font-size: 32px;
      }
    }
  </style>
</Layout>
