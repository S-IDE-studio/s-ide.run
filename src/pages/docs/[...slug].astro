---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { render } from 'astro:content';

export async function getStaticPaths() {
  const docsEntries = await getCollection('docs');
  return docsEntries.map((doc) => ({
    params: { slug: doc.id },
    props: { doc },
  }));
}

const { doc } = Astro.props;
const docsEntries = await getCollection('docs');
const docs = docsEntries.sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));
const currentIndex = docs.findIndex(d => d.id === doc.id);

// Type guards for safe array access
const hasPrevious = currentIndex > 0;
const hasNext = currentIndex < docs.length - 1;

// Astro's Content Collection already sanitizes MDX content, but we add extra layer for safety
// The rendered output from Astro is safe, this is defense-in-depth
const { Content } = await render(doc);
---

<Layout title={`${doc.data.title} - S-IDE`}>
  <section class="py-20 sm:py-32">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-8" aria-label="パンくずリスト">
        <a href="/docs" class="text-blue-400 hover:underline">← ドキュメント一覧</a>
      </nav>

      <!-- Doc Content -->
      <article class="prose prose-invert prose-blue max-w-none">
        <h1 class="text-4xl font-bold mb-4">{doc.data.title}</h1>
        {doc.data.description && (
          <p class="text-xl text-[#94a3b8] mb-8">{doc.data.description}</p>
        )}
        <!-- Using Astro's Content component which safely renders MDX -->
        <Content />
      </article>

      <!-- Navigation -->
      <nav class="mt-16 pt-8 border-t border-white/10 flex justify-between" aria-label="ドキュメントナビゲーション">
        {hasPrevious && (() => {
          const prevDoc = docs[currentIndex - 1];
          return (
            <a
              href={`/docs/${prevDoc.id}`}
              class="text-blue-400 hover:underline"
            >
              ← {prevDoc.data.title}
            </a>
          );
        })()}
        {hasNext && (() => {
          const nextDoc = docs[currentIndex + 1];
          return (
            <a
              href={`/docs/${nextDoc.id}`}
              class="text-blue-400 hover:underline ml-auto"
            >
              {nextDoc.data.title} →
            </a>
          );
        })()}
      </nav>
    </div>
  </section>
</Layout>
